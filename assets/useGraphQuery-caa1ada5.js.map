{"version":3,"file":"useGraphQuery-caa1ada5.js","sources":["../../src/composables/queries/useGraphQuery.ts"],"sourcesContent":["import axios from 'axios';\r\nimport { jsonToGraphQLQuery } from 'json-to-graphql-query';\r\nimport { initial, last } from 'lodash';\r\nimport { reactive } from 'vue';\r\nimport { useQuery, UseQueryOptions, QueryKey } from '@tanstack/vue-query';\r\n\r\nimport { configService } from '@/services/config/config.service';\r\nimport { subgraphFallbackService } from '@/services/balancer/subgraph/subgraph-fallback.service';\r\n\r\nexport const subgraphs = {\r\n  gauge: configService.network.subgraphs.gauge,\r\n};\r\n\r\nexport default function useGraphQuery<T>(\r\n  subgraphUrl: string,\r\n  key: QueryKey,\r\n  query: () => Record<any, any>,\r\n  options: UseQueryOptions<T> = {},\r\n  shouldUseSubgraphFallbackUrl?: boolean\r\n) {\r\n  const queryKey = reactive([\r\n    // for our query key style, initial are the string\r\n    // fragments of the query key\r\n    ...initial(key),\r\n    // the last one is the list of dependencies for the query\r\n    {\r\n      // extend the dependencies from the query key and add\r\n      // the current query key as a dependency\r\n      ...(last(key) as any),\r\n    },\r\n  ]);\r\n\r\n  const queryFn = async () => {\r\n    if (!subgraphUrl) {\r\n      throw new Error(`A graphQL endpoint wasn't supplied for this query`);\r\n    }\r\n\r\n    const payload = {\r\n      query: jsonToGraphQLQuery({ query: query() }),\r\n    };\r\n\r\n    try {\r\n      if (shouldUseSubgraphFallbackUrl) {\r\n        const response = await subgraphFallbackService.get(payload);\r\n        return response?.data.data;\r\n      }\r\n      const {\r\n        data: { data },\r\n      } = await axios.post(subgraphUrl, {\r\n        query: jsonToGraphQLQuery({ query: query() }),\r\n      });\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\r\n        `GraphQL request to [${subgraphUrl}] failed. Payload:`,\r\n        query,\r\n        'Error:',\r\n        error\r\n      );\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  return useQuery<T>(queryKey, queryFn, options);\r\n}\r\n"],"names":["subgraphs","configService","useGraphQuery","subgraphUrl","key","query","options","shouldUseSubgraphFallbackUrl","queryKey","reactive","initial","last","useQuery","payload","jsonToGraphQLQuery","response","subgraphFallbackService","data","axios","error"],"mappings":"kFASO,MAAMA,EAAY,CACvB,MAAOC,EAAc,QAAQ,UAAU,KACzC,EAEA,SAAwBC,EACtBC,EACAC,EACAC,EACAC,EAA8B,GAC9BC,EACA,CACA,MAAMC,EAAWC,EAAS,CAGxB,GAAGC,EAAAA,QAAQN,CAAG,EAEd,CAGE,GAAIO,EAAAA,KAAKP,CAAG,CACd,CAAA,CACD,EAkCM,OAAAQ,EAAYJ,EAhCH,SAAY,CAC1B,GAAI,CAACL,EACG,MAAA,IAAI,MAAM,mDAAmD,EAGrE,MAAMU,EAAU,CACd,MAAOC,EAAAA,mBAAmB,CAAE,MAAOT,IAAS,CAAA,EAG1C,GAAA,CACF,GAAIE,EAA8B,CAChC,MAAMQ,EAAW,MAAMC,EAAwB,IAAIH,CAAO,EAC1D,OAAOE,GAAA,YAAAA,EAAU,KAAK,IACxB,CACM,KAAA,CACJ,KAAM,CAAE,KAAAE,CAAK,CAAA,EACX,MAAMC,EAAM,KAAKf,EAAa,CAChC,MAAOW,EAAAA,mBAAmB,CAAE,MAAOT,IAAS,CAAA,CAC7C,EAEM,OAAAY,QACAE,GACC,cAAA,MACN,uBAAuBhB,sBACvBE,EACA,SACAc,CAAA,EAEIA,CACR,CAAA,EAGoCb,CAAO,CAC/C"}