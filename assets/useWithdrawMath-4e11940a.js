import{b as Oe,c as t,aS as Re,ba as ee,as as na,e as la,bR as U,y as m,u as sa,p as ra,aH as oa,ax as _,z as r,cl as Y,cq as ca,O as h,F as ia,c2 as va,cn as G,Z as M,cr as fa,l as Be,c1 as pa,bj as ma,cs as Sa,ct as da,aw as ga,cf as ha,by as xe,c8 as Ta}from"./index-4a1c513c.js";import{u as Aa,C as wa,E as ba}from"./exchange.service-4f09193f.js";import{u as Ia,H as _a}from"./poolLiquidity-de5c7424.js";import{u as ya,R as Ea}from"./useRelayerApprovalTx-95afc1c6.js";import{u as Pe}from"./useTokenHelpers-ddc69531.js";var We=(n=>(n.SINGLE_ASSET_WITHDRAWAL_MIN_BPT_LIMIT="SINGLE_ASSET_WITHDRAWAL_MIN_BPT_LIMIT",n))(We||{});const S=la({isProportional:!0,tokenOut:"",validInput:!0,highPriceImpactAccepted:!1,submitting:!1,sorReady:!1,tx:{init:!1,confirming:!1,confirmed:!1,confirmedAt:""},slider:{val:1e3,max:1e3,min:0,interval:1},error:null});function Me(n){S.error=n}function Ba(){S.tx={init:!1,confirming:!1,confirmed:!1,confirmedAt:""}}function xa(n){switch(n){case"SINGLE_ASSET_WITHDRAWAL_MIN_BPT_LIMIT":return{title:U.global.t("warning"),description:U.global.t("withdraw.errors.SINGLE_ASSET_WITHDRAWAL_MIN_BPT_LIMIT")};default:return{title:U.global.t("Ooops"),description:U.global.t("somethingWentWrong")}}}const Oa=t(()=>S.tx.init||S.tx.confirming||S.tx.confirmed);function Na(n){const{nativeAsset:f}=Oe(),{replaceWethWithEth:O}=Pe(),d=ya(Ea.BATCH),c=t(()=>{if(!n.value)return[];const v=Re(n.value)?n.value.mainTokens||[]:ee(n.value);return!S.isProportional&&S.tokenOut===f.address?O(v):v}),E=t(()=>c.value.indexOf(S.tokenOut));function T(){S.slider.val=S.slider.max}return{...na(S),tokensOut:c,tokenOutIndex:E,batchRelayerApproval:d,txInProgress:Oa,maxSlider:T,setError:Me,parseError:xa,resetTxState:Ba}}function ka(n,f=m(!0),O=m([]),d=m(""),c=m(0)){const E=m("0"),T=m(""),v=m(!1),ae=m(""),j=m("0"),i=m(null),w=m(null),L=m([]),{isWalletReady:Le,getSigner:z,account:te}=sa(),{toFiat:Ne,fNum:ke}=ra(),{tokens:ue,balances:De,balanceFor:Fe,getToken:K,dynamicDataLoading:Ce,nativeAsset:qe}=Oe(),{replaceWethWithEth:He}=Pe(),{minusSlippage:Ue,addSlippageScaled:ne,minusSlippageScaled:Ge}=Ia(),{isWeightedPool:je,isDeepPool:A,isShallowComposableStablePool:p}=oa(n),{slippageScaled:ze}=pa(),{promises:le,processing:se,processAll:re}=Aa(),R=new wa(n,ue,De,"exit"),Q=new ba(n),N=t(()=>Re(n.value)?n.value.mainTokens||[]:ee(n.value)),oe=t(()=>N.value.length),ce=t(()=>ee(n.value).map(e=>K(e))),Z=t(()=>K(d.value).decimals),b=t(()=>{var e,a;return((a=(e=n.value)==null?void 0:e.onchain)==null?void 0:a.decimals)||18}),P=t(()=>N.value.map(e=>K(e))),I=t(()=>Fe(n.value.address)),B=t(()=>_(I.value,b.value).toString()),ie=t(()=>{if(!je.value)return I.value;const e=r(n.value.totalShares).times(.3).toFixed(b.value,Y.ROUND_DOWN);return Y.min(I.value,e).toString()}),ve=t(()=>r(I.value).gt(0)),fe=t(()=>{var u,l;const e=((l=(u=n.value)==null?void 0:u.onchain)==null?void 0:l.tokens)||[];return Object.values(e).map(o=>o.balance)[c.value]}),Ke=t(()=>r(T.value).gt(fe.value)),pe=t(()=>f.value&&p.value),me=t(()=>pe.value?ca:0),k=t(()=>{let e;pe.value&&r(j.value).gt(0)&&(e={bps:1e3,value:j.value,buffer:me.value});const{receive:a}=R.propAmountsGiven(E.value,0,"send",e);return a}),Qe=t(()=>x.value&&w.value?w.value.outputs.amountsOut.map((e,a)=>{const u=r(e.toString()).abs().toString();return h(u,P.value[a].decimals)}):i.value?i.value.returnAmounts.map((e,a)=>{const u=r(e.toString()).abs().toString();return h(u,P.value[a].decimals)}):new Array(oe.value).fill("0")),Se=t(()=>A.value?Qe.value:k.value),y=t(()=>f.value?Se.value:new Array(oe.value).fill("0").map((e,a)=>a===c.value&&T.value||"0")),de=t(()=>y.value.map((e,a)=>_(e,P.value[a].decimals).toString())),J=t(()=>y.value.map((e,a)=>e==="0"||g.value||f.value&&p.value?e:Ue(e,P.value[a].decimals))),D=t(()=>{var e,a,u,l,o;if(f.value){const s=r(E.value).minus(h(me.value),18).toString();return _(s,b.value).toString()}return g.value?A.value?x.value?((a=(e=w.value)==null?void 0:e.outputs)==null?void 0:a.amountsIn)||"0":((o=(l=(u=i.value)==null?void 0:u.returnAmounts)==null?void 0:l[0])==null?void 0:o.toString())||"0":p.value?ae.value:R.bptInForExactTokenOut(T.value,c.value).toString():_(ie.value,b.value).toString()}),ge=t(()=>g.value||p.value&&!$.value?ne(D.value):D.value.toString()),he=t(()=>h(ge.value,b.value)),Te=t(()=>y.value.some(e=>r(e).gt(0))),Ae=t(()=>{if(A.value||p.value)return L.value;try{return ce.value.map((e,a)=>h(R.exactBPTInForTokenOut(B.value,a).toString(),e.decimals))}catch(e){return e.message.includes("MIN_BPT_IN_FOR_TOKEN_OUT")?(Me(We.SINGLE_ASSET_WITHDRAWAL_MIN_BPT_LIMIT),ce.value.map((a,u)=>h(R.exactBPTInForTokenOut(_(ie.value,b.value).toString(),u).toString(),a.decimals))):[]}}),$=t(()=>Ae.value[c.value]===y.value[c.value]),g=t(()=>!f.value&&!$.value),F=t(()=>!f.value&&$.value),we=t(()=>Ke.value?1:!Te.value||f.value?0:R.priceImpact(y.value,{exactOut:g.value,tokenIndex:c.value,queryBPT:D.value}).toNumber()),Ze=t(()=>r(we.value).isGreaterThanOrEqualTo(_a)),be=t(()=>y.value.map((e,a)=>{var u;return Ne(e,(u=P.value[a])==null?void 0:u.address)})),Ie=t(()=>be.value.reduce((e,a)=>r(e).plus(a).toString(),"0")),Je=t(()=>ke(Ie.value,ia.fiat)),_e=t(()=>n.value&&A.value&&r(he.value).gt(0)),x=t(()=>{var e,a;if(!A.value||!((a=(e=n.value)==null?void 0:e.onchain)!=null&&a.linearPools))return!1;if(i.value){const u=i.value.returnAmounts;return ve.value&&u.some(l=>r(l).eq(0))}return!1}),$e=t(()=>{const a=de.value.map((u,l)=>[N.value[l].toLowerCase(),u]).filter(([,u])=>r(u).gt(0)).map(([u,l])=>[u,g.value?l:Ge(l.toString())]);return Object.fromEntries(a)}),ye=t(()=>{if(F.value)return[B.value];if(g.value)return i.value?i.value.returnAmounts:[];const e=va(k.value).toString();return k.value.map(u=>r(u).div(e).times(he.value).toFixed(b.value,Y.ROUND_DOWN)).filter(u=>r(u).gt(0)).map(u=>_(u,b.value).toString())}),Ve=t(()=>F.value?[d.value]:N.value.map(e=>e.toLowerCase())),Xe=t(()=>g.value?G.SwapExactOut:G.SwapExactIn),V=t(()=>{var e,a;return((a=(e=n.value)==null?void 0:e.wrappedTokens)==null?void 0:a[c.value])||""});async function C(){await ta(),E.value=I.value,_e.value&&(le.value.push(X),se.value||re())}function Ye(){C(),T.value=""}function ea(e){var u,l,o,s;if(!((l=(u=n.value)==null?void 0:u.onchain)!=null&&l.linearPools))return"0";const a=((s=(o=Object.values(n.value.onchain.linearPools).find(W=>xe(W.wrappedToken.address,e)))==null?void 0:o.wrappedToken)==null?void 0:s.priceRate)||"0";return _(a,18).toString()}async function q(e=null,a=null,u=G.SwapExactIn){v.value=!0,e=e||ye.value;const l=e.map(()=>n.value.address),o=!i.value;try{const s=await ma().swaps.queryBatchSwapWithSor({tokensIn:l,tokensOut:a||Ve.value,swapType:u,amounts:e,fetchPools:{fetchPools:o,fetchOnChain:!0}});return v.value=!1,s}catch(s){if(s instanceof Sa&&(s==null?void 0:s.code)===da.SWAP_ZERO_RETURN_AMOUNT)return v.value=!1,{returnAmounts:Array(e.length).fill("0"),swaps:[],assets:[]};throw s}}async function H(e=null,a=null,u=!1){v.value=!0,e=e||ye.value.map(W=>W.toString()),a=a||n.value.wrappedTokens||[];const l=!w.value,o=[];a.forEach((W,ua)=>{o[ua]=ea(W)});const s=await ga.batchRelayer.stableExitStatic(te.value,n.value.address,e,a,o,ze.value,u,l);return v.value=!1,s}async function Ee(){if(p.value){const e=await Q.queryExit(z(),J.value.map(()=>"0"),O.value,I.value,c.value,!1);let a=n.value.tokens.map(o=>o.address);xe(d.value,qe.address)&&(a=He(a));const u=Ta(a,d.value),l=h(e.amountsOut[u].toString(),Z.value);L.value[c.value]=l}else if(A.value){i.value=await q([B.value],[d.value]);const e=r(i.value.returnAmounts[0].toString()).abs();if(e.gt(0)){const a=h(e.toString(),Z.value);L.value[c.value]=a}else{const a=await H([B.value.toString()],[V.value]);let u="0";if(a.outputs&&a.outputs.amountsOut){const l=r(a.outputs.amountsOut[0].toString()).abs();u=h(l.toString(),Z.value)}L.value[c.value]=u}}}async function X(){if(!(!A.value&&!p.value))if(p.value)await aa();else if(f.value)i.value=await q(),x.value&&(w.value=await H());else if(g.value){const e=de.value.filter(a=>r(a).gt(0));i.value=await q(e,[d.value],G.SwapExactOut),x.value&&(w.value=await H(e.map(a=>a.toString()),[V.value],!0))}else i.value=await q([B.value],[d.value]),x.value&&(w.value=await H([B.value.toString()],[V.value]))}async function aa(){if(!p.value)return;const e=r(I.value).plus(1).toString();try{v.value=!0;const a=await Q.queryExit(z(),J.value,O.value,e,F.value?c.value:null,g.value);ae.value=a.bptIn.toString(),v.value=!1}catch(a){console.error("Failed to fetch queryJoin",a)}}async function ta(){var l,o;if(!p.value)return;v.value=!0;const[e]=await new fa([Be.cloneDeep(n.value)]).decorate(ue.value),a=((l=e.onchain)==null?void 0:l.totalSupply)||"0",u=Object.values(((o=e.onchain)==null?void 0:o.tokens)||[]).map(s=>h(_(s.balance,s.decimals).mul(1e3).div(1e4),s.decimals));try{const s=await Q.queryExit(z(),u,O.value,a,null,!1);j.value=s.bptIn.toString(),v.value=!1}catch(s){console.error("Failed to fetch queryExit",s)}}return M(d,()=>{T.value="",(A.value||p.value)&&Ee()}),M(f,()=>{(A.value||p.value)&&Ee()}),M(Le,async()=>{await ha(Ce,!1),C()}),M(te,()=>C()),M(T,async(e,a)=>{Be.isEqual(a,e)||f.value||(le.value.push(X),se.value||re())}),{hasAmounts:Te,fullAmounts:y,amountsOut:J,fiatAmounts:be,tokenOutAmount:T,propBptIn:E,bptIn:ge,bptBalance:I,hasBpt:ve,fiatTotalLabel:Je,fiatTotal:Ie,priceImpact:we,highPriceImpact:Ze,proportionalAmounts:Se,proportionalPoolTokenAmounts:k,singleAssetMaxes:Ae,exactOut:g,singleAssetMaxOut:F,tokenOutPoolBalance:fe,shouldFetchBatchSwap:_e,batchSwap:i,batchSwapAmountsOutMap:$e,batchSwapKind:Xe,shouldUseBatchRelayer:x,batchRelayerSwap:w,loadingData:v,initMath:C,resetMath:Ye,fetchExitData:X}}export{Na as a,ka as u};
//# sourceMappingURL=useWithdrawMath-4e11940a.js.map
