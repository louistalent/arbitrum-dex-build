var Ct=Object.defineProperty;var qt=(o,e,t)=>e in o?Ct(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var F=(o,e,t)=>(qt(o,typeof e!="symbol"?e+"":e,t),t);import{y as vt,cu as jt,cv as Lt,cw as xt,z as O,cl as z,ba as ot,bZ as Xt,by as it,O as K,ax as U,bW as ut,cx as $t,cy as Vt,cz as zt,a as yt,aS as Kt,q as lt,cA as Ht,J as Tt,cB as Jt,cC as Q,cD as H,cE as nt,cF as J,b9 as pt,A as Nt,bg as Ft,cG as Qt,aa as ct,cH as rt}from"./index-4a1c513c.js";function We(){const o=vt([]),e=vt(!1);async function t(){e.value=!0;for(let n=0;n<o.value.length;n++)await o.value[n](),o.value.splice(n,1);e.value=!1}return{promises:o,processing:e,processAll:t}}var X={},bt={},st={};Object.defineProperty(st,"__esModule",{value:!0});st.getPool=void 0;const mt=jt,Yt=async(o,e,t)=>{const n=`
    id
    address
    poolType
    swapFee
    totalShares
    amp
    tokens {
      id
      address
      symbol
      balance
      decimals
      weight
    }
  `;let i;e?i=mt.gql`
      query getPool($poolId: ID!, $blockNumber: Int!) {
        pools(where: { id: $poolId }, block: { number: $blockNumber }) {
          ${n}
        }
      }
    `:i=mt.gql`
      query getPool($poolId: ID!) {
        pools(where: { id: $poolId }) {
          ${n}
        }
      }
    `;const s=await mt.request(t?"https://api.thegraph.com/subgraphs/name/balancer-labs/balancer-kovan-v2":"https://api.thegraph.com/subgraphs/name/balancer-labs/balancer-v2",i,{poolId:o,blockNumber:e});return s&&s.pools&&s.pools.length?s.pools[0]:null};st.getPool=Yt;var $={};const te=Lt(xt);(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.scaleAll=o.scale=o.bn=void 0;const e=te;e.BigNumber.config({EXPONENTIAL_AT:[-100,100],ROUNDING_MODE:1,DECIMAL_PLACES:18}),o.default=e.BigNumber;const t=s=>new e.BigNumber(s);o.bn=t;const n=(s,l)=>o.bn(s).times(o.bn(10).pow(l));o.scale=n;const i=(s,l)=>s.map(c=>o.scale(c,l));o.scaleAll=i})($);var Ot={};(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.shallowCopyAll=o.shallowCopy=void 0;const e=n=>Object.assign({},n);o.shallowCopy=e;const t=n=>n.map(o.shallowCopy);o.shallowCopyAll=t})(Ot);var ht={},Et={};(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.divUp=o.divDown=o.div=o.mul=o.min=o.max=o.sub=o.add=o.TWO=o.ONE=o.ZERO=void 0;const e=$;o.ZERO=e.bn(0),o.ONE=e.bn(1),o.TWO=e.bn(2);const t=(h,m)=>h.plus(m);o.add=t;const n=(h,m)=>{if(m.gt(h))throw new Error("SUB_OVERFLOW");return h.minus(m)};o.sub=n;const i=(h,m)=>h.gte(m)?h:m;o.max=i;const s=(h,m)=>h.lt(m)?h:m;o.min=s;const l=(h,m)=>h.times(m);o.mul=l;const c=(h,m,b)=>b?o.divUp(h,m):o.divDown(h,m);o.div=c;const r=(h,m)=>{if(m.isZero())throw new Error("ZERO_DIVISION");return h.idiv(m)};o.divDown=r;const d=(h,m)=>{if(m.isZero())throw new Error("ZERO_DIVISION");return h.isZero()?o.ZERO:o.ONE.plus(h.minus(o.ONE).idiv(m))};o.divUp=d})(Et);Object.defineProperty(ht,"__esModule",{value:!0});const L=$,_t=Et;class ee{constructor(e){this.MIN_SWAP_FEE_PERCENTAGE=L.bn("0.000001"),this.MAX_SWAP_FEE_PERCENTAGE=L.bn("0.1"),this._query=!1,this._id=e.id,this._address=e.address,this._bptTotalSupply=e.bptTotalSupply,this.setSwapFeePercentage(e.swapFeePercentage),e.query&&(this._query=e.query)}get id(){return this._id}get address(){return this._address}get bptTotalSupply(){return this._bptTotalSupply}get swapFeePercentage(){return this._swapFeePercentage}get query(){return this._query}setSwapFeePercentage(e){if(L.bn(e).lt(this.MIN_SWAP_FEE_PERCENTAGE))throw new Error("MIN_SWAP_FEE_PERCENTAGE");if(L.bn(e).gt(this.MAX_SWAP_FEE_PERCENTAGE))throw new Error("MAX_SWAP_FEE_PERCENTAGE");this._swapFeePercentage=e}setQuery(e){this._query=e}_upScale(e,t){return _t.mul(L.scale(e,t),L.bn(10).pow(18-t))}_downScaleDown(e,t){return L.scale(_t.divDown(L.bn(e),L.bn(10).pow(18-t)),-t)}_downScaleUp(e,t){return L.scale(_t.divUp(L.bn(e),L.bn(10).pow(18-t)),-t)}}ht.default=ee;var gt={},kt={},Rt={};(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.ln=o.log=o.exp=o.pow=void 0;const e=$,t=e.bn("1000000000000000000"),n=e.bn("100000000000000000000"),i=e.bn("1000000000000000000000000000000000000"),s=e.bn("130000000000000000000"),l=e.bn("-41000000000000000000"),c=t.minus(e.bn("100000000000000000")),r=t.plus(e.bn("100000000000000000")),d=e.bn(2).pow(254).idiv(n),h=e.bn("128000000000000000000"),m=e.bn("38877084059945950922200000000000000000000000000000000000"),b=e.bn("64000000000000000000"),S=e.bn("6235149080811616882910000000"),g=e.bn("3200000000000000000000"),p=e.bn("7896296018268069516100000000000000"),E=e.bn("1600000000000000000000"),I=e.bn("888611052050787263676000000"),P=e.bn("800000000000000000000"),A=e.bn("298095798704172827474000"),f=e.bn("400000000000000000000"),y=e.bn("5459815003314423907810"),N=e.bn("200000000000000000000"),G=e.bn("738905609893065022723"),M=e.bn("100000000000000000000"),Z=e.bn("271828182845904523536"),v=e.bn("50000000000000000000"),B=e.bn("164872127070012814685"),q=e.bn("25000000000000000000"),C=e.bn("128402541668774148407"),Dt=e.bn("12500000000000000000"),It=e.bn("113314845306682631683"),Ut=e.bn("6250000000000000000"),Pt=e.bn("106449445891785942956"),Mt=(u,k)=>{if(k.isZero())return t;if(u.isZero())return e.bn(0);if(u.gte(e.bn(2).pow(255)))throw new Error("X_OUT_OF_BOUNDS");if(k.gte(d))throw new Error("Y_OUT_OF_BOUNDS");let w;if(c.lt(u)&&u.lt(r)){let T=at(u);w=T.idiv(t).times(k).plus(T.mod(t).times(k).idiv(t))}else w=Y(u).times(k);if(w=w.idiv(t),w.lt(l)||w.gt(s))throw new Error("PRODUCT_OUT_OF_BOUNDS");return o.exp(w)};o.pow=Mt;const Gt=u=>{if(u.lt(l)||u.gt(s))throw new Error("INVALID_EXPONENT");if(u.lt(0))return t.times(t).idiv(o.exp(u.negated()));let k;u.gte(h)?(u=u.minus(h),k=m):u.gte(b)?(u=u.minus(b),k=S):k=e.bn(1),u=u.times(100);let w=n;u.gte(g)&&(u=u.minus(g),w=w.times(p).idiv(n)),u.gte(E)&&(u=u.minus(E),w=w.times(I).idiv(n)),u.gte(P)&&(u=u.minus(P),w=w.times(A).idiv(n)),u.gte(f)&&(u=u.minus(f),w=w.times(y).idiv(n)),u.gte(N)&&(u=u.minus(N),w=w.times(G).idiv(n)),u.gte(M)&&(u=u.minus(M),w=w.times(Z).idiv(n)),u.gte(v)&&(u=u.minus(v),w=w.times(B).idiv(n)),u.gte(q)&&(u=u.minus(q),w=w.times(C).idiv(n));let T=n,_;return _=u,T=T.plus(_),_=_.times(u).idiv(n).idiv(2),T=T.plus(_),_=_.times(u).idiv(n).idiv(3),T=T.plus(_),_=_.times(u).idiv(n).idiv(4),T=T.plus(_),_=_.times(u).idiv(n).idiv(5),T=T.plus(_),_=_.times(u).idiv(n).idiv(6),T=T.plus(_),_=_.times(u).idiv(n).idiv(7),T=T.plus(_),_=_.times(u).idiv(n).idiv(8),T=T.plus(_),_=_.times(u).idiv(n).idiv(9),T=T.plus(_),_=_.times(u).idiv(n).idiv(10),T=T.plus(_),_=_.times(u).idiv(n).idiv(11),T=T.plus(_),_=_.times(u).idiv(n).idiv(12),T=T.plus(_),w.times(T).idiv(n).times(k).idiv(100)};o.exp=Gt;const Wt=(u,k)=>{let w;c.lt(k)&&k.lt(r)?w=at(k):w=Y(k).times(t);let T;return c.lt(u)&&u.lt(r)?T=at(u):T=Y(u).times(t),T.times(t).idiv(w)};o.log=Wt;const Zt=u=>{if(u.lte(0))throw new Error("OUT_OF_BOUNDS");return c.lt(u)&&u.lt(r)?at(u).idiv(t):Y(u)};o.ln=Zt;const Y=u=>{if(u.lt(t))return Y(t.times(t).idiv(u)).negated();let k=e.bn(0);u.gte(m.times(t))&&(u=u.idiv(m),k=k.plus(h)),u.gte(S.times(t))&&(u=u.idiv(S),k=k.plus(b)),k=k.times(100),u=u.times(100),u.gte(p)&&(u=u.times(n).idiv(p),k=k.plus(g)),u.gte(I)&&(u=u.times(n).idiv(I),k=k.plus(E)),u.gte(A)&&(u=u.times(n).idiv(A),k=k.plus(P)),u.gte(y)&&(u=u.times(n).idiv(y),k=k.plus(f)),u.gte(G)&&(u=u.times(n).idiv(G),k=k.plus(N)),u.gte(Z)&&(u=u.times(n).idiv(Z),k=k.plus(M)),u.gte(B)&&(u=u.times(n).idiv(B),k=k.plus(v)),u.gte(C)&&(u=u.times(n).idiv(C),k=k.plus(q)),u.gte(It)&&(u=u.times(n).idiv(It),k=k.plus(Dt)),u.gte(Pt)&&(u=u.times(n).idiv(Pt),k=k.plus(Ut));const w=u.minus(n).times(n).idiv(u.plus(n)),T=w.times(w).idiv(n);let _=w,j=_;return _=_.times(T).idiv(n),j=j.plus(_.idiv(3)),_=_.times(T).idiv(n),j=j.plus(_.idiv(5)),_=_.times(T).idiv(n),j=j.plus(_.idiv(7)),_=_.times(T).idiv(n),j=j.plus(_.idiv(9)),_=_.times(T).idiv(n),j=j.plus(_.idiv(11)),j=j.times(2),k.plus(j).idiv(100)},at=u=>{u=u.times(t);const k=u.minus(i).times(i).idiv(u.plus(i)),w=k.times(k).idiv(i);let T=k,_=T;return T=T.times(w).idiv(i),_=_.plus(T.idiv(3)),T=T.times(w).idiv(i),_=_.plus(T.idiv(5)),T=T.times(w).idiv(i),_=_.plus(T.idiv(7)),T=T.times(w).idiv(i),_=_.plus(T.idiv(9)),T=T.times(w).idiv(i),_=_.plus(T.idiv(11)),T=T.times(w).idiv(i),_=_.plus(T.idiv(13)),T=T.times(w).idiv(i),_=_.plus(T.idiv(15)),_.times(2)}})(Rt);(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.complement=o.powUp=o.powDown=o.divUp=o.divDown=o.mulUp=o.mulDown=o.sub=o.add=o.MIN_POW_BASE_FREE_EXPONENT=o.MAX_POW_RELATIVE_ERROR=o.ONE=o.ZERO=void 0;const e=$,t=Rt;o.ZERO=e.bn(0),o.ONE=e.bn("1000000000000000000"),o.MAX_POW_RELATIVE_ERROR=e.bn(1e4),o.MIN_POW_BASE_FREE_EXPONENT=e.bn("700000000000000000");const n=(b,S)=>b.plus(S);o.add=n;const i=(b,S)=>{if(S.gt(b))throw new Error("SUB_OVERFLOW");return b.minus(S)};o.sub=i;const s=(b,S)=>b.times(S).idiv(o.ONE);o.mulDown=s;const l=(b,S)=>{const g=b.times(S);return g.isZero()?g:g.minus(e.bn(1)).idiv(o.ONE).plus(e.bn(1))};o.mulUp=l;const c=(b,S)=>{if(S.isZero())throw new Error("ZERO_DIVISION");return b.isZero()?b:b.times(o.ONE).idiv(S)};o.divDown=c;const r=(b,S)=>{if(S.isZero())throw new Error("ZERO_DIVISION");return b.isZero()?b:b.times(o.ONE).minus(e.bn(1)).idiv(S).plus(e.bn(1))};o.divUp=r;const d=(b,S)=>{const g=t.pow(b,S),p=o.add(o.mulUp(g,o.MAX_POW_RELATIVE_ERROR),e.bn(1));return g.lt(p)?e.bn(0):o.sub(g,p)};o.powDown=d;const h=(b,S)=>{const g=t.pow(b,S),p=o.add(o.mulUp(g,o.MAX_POW_RELATIVE_ERROR),e.bn(1));return o.add(g,p)};o.powUp=h;const m=b=>b.lt(o.ONE)?o.ONE.minus(b):e.bn(0);o.complement=m})(kt);(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o._calcDueTokenProtocolSwapFeeAmount=o._calcTokensOutGivenExactBptIn=o._calcTokenOutGivenExactBptIn=o._calcBptInGivenExactTokensOut=o._calcTokenInGivenExactBptOut=o._calcBptOutGivenExactTokensIn=o._calcInGivenOut=o._calcOutGivenIn=o._calculateInvariant=o.MAX_STABLE_TOKENS=o.AMP_PRECISION=o.MAX_AMP=o.MIN_AMP=void 0;const e=$,t=kt,n=Et;o.MIN_AMP=e.bn(1),o.MAX_AMP=e.bn(5e3),o.AMP_PRECISION=e.bn(1e3),o.MAX_STABLE_TOKENS=5;const i=(g,p,E)=>{let I=n.ZERO,P=e.bn(p.length);for(let N=0;N<p.length;N++)I=t.add(I,p[N]);if(I.isZero())return n.ZERO;let A=n.ZERO,f=I,y=n.mul(g,P);for(let N=0;N<255;N++){let G=n.mul(P,p[0]);for(let M=1;M<p.length;M++)G=n.div(n.mul(n.mul(G,p[M]),P),f,E);if(A=f,f=n.div(t.add(n.mul(n.mul(P,f),f),n.div(n.mul(n.mul(y,I),G),o.AMP_PRECISION,E)),t.add(n.mul(t.add(P,n.ONE),f),n.div(n.mul(t.sub(y,o.AMP_PRECISION),G),o.AMP_PRECISION,!E)),E),f.gt(A)){if(t.sub(f,A).lte(n.ONE))return f}else if(t.sub(A,f).lte(n.ONE))return f}throw new Error("STABLE_GET_BALANCE_DIDNT_CONVERGE")};o._calculateInvariant=i;const s=(g,p,E,I,P,A)=>{A&&(P=t.sub(P,t.mulUp(P,A)));const f=o._calculateInvariant(g,p,!0);p[E]=t.add(p[E],P);const y=S(g,p,f,I);return p[E]=t.sub(p[E],P),t.sub(t.sub(p[I],y),n.ONE)};o._calcOutGivenIn=s;const l=(g,p,E,I,P,A)=>{const f=o._calculateInvariant(g,p,!0);p[I]=t.sub(p[I],P);const y=S(g,p,f,E);p[I]=t.add(p[I],P);let N=t.add(t.sub(y,p[E]),n.ONE);return A&&(N=t.divUp(N,t.complement(A))),N};o._calcInGivenOut=l;const c=(g,p,E,I,P)=>{let A=n.ZERO;for(let v=0;v<p.length;v++)A=t.add(A,p[v]);const f=new Array(E.length);let y=n.ZERO;for(let v=0;v<p.length;v++){const B=t.divDown(p[v],A);f[v]=t.divDown(t.add(p[v],E[v]),p[v]),y=t.add(y,t.mulDown(f[v],B))}const N=new Array(p.length);for(let v=0;v<p.length;v++){let B;if(f[v].gt(y)){const q=t.mulDown(p[v],t.sub(y,t.ONE)),C=t.sub(E[v],q);B=t.add(q,t.mulDown(C,t.sub(t.ONE,P)))}else B=E[v];N[v]=t.add(p[v],B)}const G=o._calculateInvariant(g,p,!0),M=o._calculateInvariant(g,N,!1),Z=t.divDown(M,G);return Z.gt(t.ONE)?t.mulDown(I,t.sub(Z,t.ONE)):n.ZERO};o._calcBptOutGivenExactTokensIn=c;const r=(g,p,E,I,P,A)=>{const f=o._calculateInvariant(g,p,!0),y=t.mulUp(t.divUp(t.add(P,I),P),f),N=S(g,p,y,E),G=t.sub(N,p[E]);let M=n.ZERO;for(let C=0;C<p.length;C++)M=t.add(M,p[C]);const Z=t.divDown(p[E],M),v=t.complement(Z),B=t.mulUp(G,v),q=t.sub(G,B);return t.add(q,t.divUp(B,t.sub(t.ONE,A)))};o._calcTokenInGivenExactBptOut=r;const d=(g,p,E,I,P)=>{let A=n.ZERO;for(let v=0;v<p.length;v++)A=t.add(A,p[v]);const f=new Array(E.length);let y=n.ZERO;for(let v=0;v<p.length;v++){const B=t.divUp(p[v],A);f[v]=t.divUp(t.sub(p[v],E[v]),p[v]),y=t.add(y,t.mulUp(f[v],B))}const N=new Array(p.length);for(let v=0;v<p.length;v++){let B;if(y.gt(f[v])){const q=t.mulDown(p[v],t.complement(y)),C=t.sub(E[v],q);B=t.add(q,t.divUp(C,t.sub(t.ONE,P)))}else B=E[v];N[v]=t.sub(p[v],B)}const G=o._calculateInvariant(g,p,!0),M=o._calculateInvariant(g,N,!1),Z=t.divDown(M,G);return t.mulUp(I,t.complement(Z))};o._calcBptInGivenExactTokensOut=d;const h=(g,p,E,I,P,A)=>{const f=o._calculateInvariant(g,p,!0),y=t.mulUp(t.divUp(t.sub(P,I),P),f),N=S(g,p,y,E),G=t.sub(p[E],N);let M=n.ZERO;for(let C=0;C<p.length;C++)M=t.add(M,p[C]);const Z=t.divDown(p[E],M),v=t.complement(Z),B=t.mulUp(G,v),q=t.sub(G,B);return t.add(q,t.mulDown(B,t.sub(t.ONE,A)))};o._calcTokenOutGivenExactBptIn=h;const m=(g,p,E)=>{const I=t.divDown(p,E),P=new Array(g.length);for(let A=0;A<g.length;A++)P[A]=t.mulDown(g[A],I);return P};o._calcTokensOutGivenExactBptIn=m;const b=(g,p,E,I,P)=>{const A=S(g,p,E,I);if(p[I].lte(A))return n.ZERO;const f=t.sub(p[I],A);return t.divDown(t.mulDown(f,P),t.ONE)};o._calcDueTokenProtocolSwapFeeAmount=b;const S=(g,p,E,I)=>{const P=e.bn(p.length),A=n.mul(g,P);let f=p[0],y=n.mul(P,p[0]);for(let B=1;B<p.length;B++)y=n.divDown(n.mul(n.mul(y,p[B]),P),E),f=t.add(f,p[B]);f=t.sub(f,p[I]);const N=n.mul(E,E),G=n.mul(n.mul(n.divUp(N,n.mul(A,y)),o.AMP_PRECISION),p[I]),M=t.add(f,n.mul(n.divDown(E,A),o.AMP_PRECISION));let Z=n.ZERO,v=n.divUp(t.add(N,G),t.add(E,M));for(let B=0;B<255;B++)if(Z=v,v=n.divUp(t.add(n.mul(v,v),G),t.sub(t.add(n.mul(v,n.TWO),M),E)),v.gt(Z)){if(t.sub(v,Z).lte(n.ONE))return v}else if(t.sub(Z,v).lte(n.ONE))return v;throw new Error("STABLE_GET_BALANCE_DIDNT_CONVERGE")}})(gt);Object.defineProperty(bt,"__esModule",{value:!0});const ne=st,R=$,At=Ot,oe=ht,x=gt;class St extends oe.default{constructor(e){if(super(e),e.tokens.length>x.MAX_STABLE_TOKENS)throw new Error("MAX_STABLE_TOKENS");if(this._tokens=At.shallowCopyAll(e.tokens),R.bn(e.amplificationParameter).lt(x.MIN_AMP))throw new Error("MIN_AMP");if(R.bn(e.amplificationParameter).gt(x.MAX_AMP))throw new Error("MAX_AMP");this._amplificationParameter=R.bn(e.amplificationParameter).times(x.AMP_PRECISION).toString()}get tokens(){return At.shallowCopyAll(this._tokens)}get amplificationParameter(){return R.bn(this._amplificationParameter).idiv(x.AMP_PRECISION).toString()}static async initFromRealPool(e,t=!1,n,i){const s=await ne.getPool(e,n,i);if(!s)throw new Error("Could not fetch pool data");if(s.poolType!=="Stable")throw new Error("Pool must be stable");const l=s.id,c=s.address,r=s.totalShares,d=s.swapFee,h=s.amp,m=[];for(const b of s.tokens)m.push({address:b.address,symbol:b.symbol,balance:b.balance,decimals:b.decimals});return new St({id:l,address:c,tokens:m,bptTotalSupply:r,swapFeePercentage:d,amplificationParameter:h,query:t})}swapGivenIn(e,t,n){const i=this._tokens.findIndex(h=>h.symbol===e),s=this._tokens.findIndex(h=>h.symbol===t),l=this._tokens[i],c=this._tokens[s],r=x._calcOutGivenIn(R.bn(this._amplificationParameter),this._tokens.map(h=>this._upScale(h.balance,h.decimals)),i,s,this._upScale(n,l.decimals),this._upScale(this._swapFeePercentage,18)),d=this._downScaleDown(r,c.decimals);return this._query||(l.balance=R.bn(l.balance).plus(n).toString(),c.balance=R.bn(c.balance).minus(d).toString()),d.toString()}swapGivenOut(e,t,n){const i=this._tokens.findIndex(h=>h.symbol===e),s=this._tokens.findIndex(h=>h.symbol===t),l=this._tokens[i],c=this._tokens[s],r=x._calcInGivenOut(R.bn(this._amplificationParameter),this._tokens.map(h=>this._upScale(h.balance,h.decimals)),i,s,this._upScale(n,c.decimals),this._upScale(this._swapFeePercentage,18)),d=this._downScaleUp(r,l.decimals);return this._query||(l.balance=R.bn(l.balance).plus(d).toString(),c.balance=R.bn(c.balance).minus(n).toString()),d.toString()}joinExactTokensInForBptOut(e){if(Object.keys(e).length!==this._tokens.length)throw new Error("Invalid input");const t=x._calcBptOutGivenExactTokensIn(R.bn(this._amplificationParameter),this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._tokens.map(i=>this._upScale(e[i.symbol],i.decimals)),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),n=this._downScaleDown(t,18);if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=R.bn(s.balance).plus(e[s.symbol]).toString()}this._bptTotalSupply=R.bn(this._bptTotalSupply).plus(n).toString()}return n.toString()}joinTokenInForExactBptOut(e,t){const n=this._tokens.findIndex(c=>c.symbol===e),i=this._tokens[n];if(!i)throw new Error("Invalid input");const s=x._calcTokenInGivenExactBptOut(R.bn(this._amplificationParameter),this._tokens.map(c=>this._upScale(c.balance,c.decimals)),n,this._upScale(t,18),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),l=this._downScaleUp(s,i.decimals);return this._query||(i.balance=R.bn(i.balance).plus(l).toString(),this._bptTotalSupply=R.bn(this._bptTotalSupply).plus(t).toString()),l.toString()}exitExactBptInForTokenOut(e,t){const n=this._tokens.findIndex(c=>c.symbol===e),i=this._tokens[n];if(!i)throw new Error("Invalid input");const s=x._calcTokenOutGivenExactBptIn(R.bn(this._amplificationParameter),this._tokens.map(c=>this._upScale(c.balance,c.decimals)),n,this._upScale(t,18),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),l=this._downScaleDown(s,i.decimals);return this._query||(i.balance=R.bn(i.balance).minus(l).toString(),this._bptTotalSupply=R.bn(this._bptTotalSupply).minus(t).toString()),l.toString()}exitExactBptInForTokensOut(e){if(R.bn(e).gt(this._bptTotalSupply))throw new Error("BPT in exceeds total supply");const n=x._calcTokensOutGivenExactBptIn(this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._upScale(e,18),this._upScale(this._bptTotalSupply,18)).map((i,s)=>this._downScaleDown(i,this._tokens[s].decimals));if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=R.bn(s.balance).minus(n[i]).toString()}this._bptTotalSupply=R.bn(this._bptTotalSupply).minus(e).toString()}return n.map(i=>i.toString())}exitBptInForExactTokensOut(e){if(Object.keys(e).length!==this._tokens.length)throw new Error("Invalid input");const t=x._calcBptInGivenExactTokensOut(R.bn(this._amplificationParameter),this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._tokens.map(i=>this._upScale(e[i.symbol],i.decimals)),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),n=this._downScaleDown(t,18);if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=R.bn(s.balance).minus(e[s.symbol]).toString()}this._bptTotalSupply=R.bn(this._bptTotalSupply).minus(n).toString()}return n.toString()}}bt.default=St;var wt={},D={};Object.defineProperty(D,"__esModule",{value:!0});D._calcBptInGivenExactTokenOut=D._calcBptOutGivenExactTokenIn=D._calcDueTokenProtocolSwapFeeAmount=D._calcTokensOutGivenExactBptIn=D._calcTokenOutGivenExactBptIn=D._calcBptInGivenExactTokensOut=D._calcTokenInGivenExactBptOut=D._calcBptOutGivenExactTokensIn=D._calcInGivenOut=D._calcOutGivenIn=D._calculateInvariant=void 0;const dt=$,a=kt,ie=dt.bn("300000000000000000"),se=dt.bn("300000000000000000"),ae=dt.bn("3000000000000000000"),le=dt.bn("700000000000000000"),ce=(o,e)=>{let t=a.ONE;for(let n=0;n<o.length;n++)t=a.mulDown(t,a.powDown(e[n],o[n]));if(t.lte(a.ZERO))throw new Error("ZERO_INVARIANT");return t};D._calculateInvariant=ce;const re=(o,e,t,n,i,s)=>{if(s&&(i=a.sub(i,a.mulUp(i,s))),i.gt(a.mulDown(o,ie)))throw new Error("MAX_IN_RATIO");const l=a.add(o,i),c=a.divUp(o,l),r=a.divDown(e,n),d=a.powUp(c,r);return a.mulDown(t,a.complement(d))};D._calcOutGivenIn=re;const ue=(o,e,t,n,i,s)=>{if(i.gt(a.mulDown(t,se)))throw new Error("MAX_OUT_RATIO");const l=a.divUp(t,a.sub(t,i)),c=a.divUp(n,e),r=a.powUp(l,c),d=a.sub(r,a.ONE);let h=a.mulUp(o,d);return s&&(h=a.divUp(h,a.complement(s))),h};D._calcInGivenOut=ue;const pe=(o,e,t,n,i)=>{const s=new Array(t.length);let l=a.ZERO;for(let r=0;r<o.length;r++)s[r]=a.divDown(a.add(o[r],t[r]),o[r]),l=a.add(l,a.mulDown(s[r],e[r]));let c=a.ONE;for(let r=0;r<o.length;r++){let d;if(s[r].gt(l)){const m=a.mulDown(o[r],a.sub(l,a.ONE)),b=a.sub(t[r],m);d=a.add(m,a.mulDown(b,a.sub(a.ONE,i)))}else d=t[r];const h=a.divDown(a.add(o[r],d),o[r]);c=a.mulDown(c,a.powDown(h,e[r]))}return c.gte(a.ONE)?a.mulDown(n,a.sub(c,a.ONE)):a.ZERO};D._calcBptOutGivenExactTokensIn=pe;const he=(o,e,t,n,i)=>{const s=a.divUp(a.add(n,t),n);if(s.gt(ae))throw new Error("MAX_OUT_BPT_FOR_TOKEN_IN");const l=a.powUp(s,a.divUp(a.ONE,e)),c=a.mulUp(o,a.sub(l,a.ONE)),r=a.complement(e),d=a.mulUp(c,r),h=a.sub(c,d);return a.add(h,a.divUp(d,a.complement(i)))};D._calcTokenInGivenExactBptOut=he;const de=(o,e,t,n,i)=>{const s=new Array(t.length);let l=a.ZERO;for(let r=0;r<o.length;r++)s[r]=a.divUp(a.sub(o[r],t[r]),o[r]),l=a.add(l,a.mulUp(s[r],e[r]));let c=a.ONE;for(let r=0;r<o.length;r++){let d;if(l.gt(s[r])){const m=a.mulDown(o[r],a.complement(l)),b=a.sub(t[r],m);d=a.add(m,a.divUp(b,a.complement(i)))}else d=t[r];const h=a.divDown(a.sub(o[r],d),o[r]);c=a.mulDown(c,a.powDown(h,e[r]))}return a.mulUp(n,a.complement(c))};D._calcBptInGivenExactTokensOut=de;const me=(o,e,t,n,i)=>{const s=a.divUp(a.sub(n,t),n);if(s.lt(le))throw new Error("MIN_BPT_IN_FOR_TOKEN_OUT");const l=a.powUp(s,a.divDown(a.ONE,e)),c=a.mulDown(o,a.complement(l)),r=a.complement(e),d=a.mulUp(c,r),h=a.sub(c,d);return a.add(h,a.mulDown(d,a.complement(i)))};D._calcTokenOutGivenExactBptIn=me;const _e=(o,e,t)=>{const n=a.divDown(e,t),i=new Array(o.length);for(let s=0;s<o.length;s++)i[s]=a.mulDown(o[s],n);return i};D._calcTokensOutGivenExactBptIn=_e;const ve=(o,e,t,n,i)=>{if(n.lte(t))return a.ZERO;let s=a.divUp(t,n);const l=a.divDown(a.ONE,e);s=s.gte(a.MIN_POW_BASE_FREE_EXPONENT)?s:a.MIN_POW_BASE_FREE_EXPONENT;const c=a.powUp(s,l),r=a.mulDown(o,a.complement(c));return a.mulDown(r,i)};D._calcDueTokenProtocolSwapFeeAmount=ve;const Te=(o,e,t,n,i)=>{const s=a.divDown(a.add(o,t),o),l=a.mulDown(s,e);let c=a.ONE,r;l.gte(s)?r=a.ZERO:r=a.divUp(a.sub(s,l),a.sub(s,a.ONE));const d=a.mulUp(i,r),h=a.mulDown(t,a.complement(d)),m=a.add(a.ONE,a.divDown(h,o));return c=a.mulDown(c,a.powDown(m,e)),a.mulDown(n,a.sub(c,a.ONE))};D._calcBptOutGivenExactTokenIn=Te;function be(o,e,t,n,i){const s=a.divUp(a.sub(o,t),o),l=a.mulUp(s,e);let c=a.ONE,r;l.lte(s)?r=a.ZERO:r=a.divUp(a.sub(l,s),a.complement(s));const d=a.mulUp(i,r),h=a.divUp(t,a.complement(d)),m=a.complement(a.divUp(h,o));return c=a.mulDown(c,a.powDown(m,e)),a.mulUp(n,a.complement(c))}D._calcBptInGivenExactTokenOut=be;Object.defineProperty(wt,"__esModule",{value:!0});const Oe=st,W=$,Bt=Ot,Ee=ht,V=D;class ft extends Ee.default{constructor(e){if(super(e),this.MIN_TOKENS=2,this.MAX_TOKENS=8,this.MIN_WEIGHT=W.bn("0.01"),e.tokens.length<this.MIN_TOKENS)throw new Error("MIN_TOKENS");if(e.tokens.length>this.MAX_TOKENS)throw new Error("MAX_TOKENS");this._tokens=Bt.shallowCopyAll(e.tokens);let t=W.bn(0);for(let n=0;n<e.tokens.length;n++){if(W.bn(e.tokens[n].weight).lt(this.MIN_WEIGHT))throw new Error("MIN_WEIGHT");t=t.plus(e.tokens[n].weight)}if(!t.eq(1))throw new Error("NORMALIZED_WEIGHT_INVARIANT")}get tokens(){return Bt.shallowCopyAll(this._tokens)}static async initFromRealPool(e,t=!1,n,i){const s=await Oe.getPool(e,n,i);if(!s)throw new Error("Could not fetch pool data");if(s.poolType!=="Weighted")throw new Error("Pool must be weighted");const l=s.id,c=s.address,r=s.totalShares,d=s.swapFee,h=[];for(const m of s.tokens)h.push({address:m.address,symbol:m.symbol,balance:m.balance,decimals:m.decimals,weight:m.weight});return new ft({id:l,address:c,tokens:h,bptTotalSupply:r,swapFeePercentage:d,query:t})}getInvariant(){return V._calculateInvariant(this._tokens.map(t=>this._upScale(t.weight,18)),this._tokens.map(t=>this._upScale(t.balance,t.decimals))).toString()}swapGivenIn(e,t,n){const i=this._tokens.find(r=>r.symbol===e),s=this._tokens.find(r=>r.symbol===t),l=V._calcOutGivenIn(this._upScale(i.balance,i.decimals),this._upScale(i.weight,18),this._upScale(s.balance,s.decimals),this._upScale(s.weight,18),this._upScale(n,i.decimals),this._upScale(this._swapFeePercentage,18)),c=this._downScaleDown(l,s.decimals);return this._query||(i.balance=W.bn(i.balance).plus(n).toString(),s.balance=W.bn(s.balance).minus(c).toString()),c.toString()}swapGivenOut(e,t,n){const i=this._tokens.find(r=>r.symbol===e),s=this._tokens.find(r=>r.symbol===t),l=V._calcInGivenOut(this._upScale(i.balance,i.decimals),this._upScale(i.weight,18),this._upScale(s.balance,s.decimals),this._upScale(s.weight,18),this._upScale(n,s.decimals),this._upScale(this._swapFeePercentage,18)),c=this._downScaleUp(l,i.decimals);return this._query||(i.balance=W.bn(i.balance).plus(c).toString(),s.balance=W.bn(s.balance).minus(n).toString()),c.toString()}joinExactTokensInForBptOut(e){if(Object.keys(e).length!==this._tokens.length)throw new Error("Invalid input");const t=V._calcBptOutGivenExactTokensIn(this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._tokens.map(i=>this._upScale(i.weight,18)),this._tokens.map(i=>this._upScale(e[i.symbol],i.decimals)),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),n=this._downScaleDown(t,18);if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=W.bn(s.balance).plus(e[s.symbol]).toString()}this._bptTotalSupply=W.bn(this._bptTotalSupply).plus(n).toString()}return n.toString()}joinTokenInForExactBptOut(e,t){const n=this._tokens.find(l=>l.symbol===e);if(!n)throw new Error("Invalid input");const i=V._calcTokenInGivenExactBptOut(this._upScale(n.balance,n.decimals),this._upScale(n.weight,18),this._upScale(t,18),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),s=this._downScaleUp(i,n.decimals);return this._query||(n.balance=W.bn(n.balance).plus(s).toString(),this._bptTotalSupply=W.bn(this._bptTotalSupply).plus(t).toString()),s.toString()}exitExactBptInForTokenOut(e,t){const n=this._tokens.find(l=>l.symbol===e);if(!n)throw new Error("Invalid input");const i=V._calcTokenOutGivenExactBptIn(this._upScale(n.balance,n.decimals),this._upScale(n.weight,18),this._upScale(t,18),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),s=this._downScaleDown(i,n.decimals);return this._query||(n.balance=W.bn(n.balance).minus(s).toString(),this._bptTotalSupply=W.bn(this._bptTotalSupply).minus(t).toString()),s.toString()}exitExactBptInForTokensOut(e){if(W.bn(e).gt(this._bptTotalSupply))throw new Error("BPT in exceeds total supply");const n=V._calcTokensOutGivenExactBptIn(this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._upScale(e,18),this._upScale(this._bptTotalSupply,18)).map((i,s)=>this._downScaleDown(i,this._tokens[s].decimals));if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=W.bn(s.balance).minus(n[i]).toString()}this._bptTotalSupply=W.bn(this._bptTotalSupply).minus(e).toString()}return n.map(i=>i.toString())}exitBptInForExactTokensOut(e){if(Object.keys(e).length!==this._tokens.length)throw new Error("Invalid input");const t=V._calcBptInGivenExactTokensOut(this._tokens.map(i=>this._upScale(i.balance,i.decimals)),this._tokens.map(i=>this._upScale(i.weight,18)),this._tokens.map(i=>this._upScale(e[i.symbol],i.decimals)),this._upScale(this._bptTotalSupply,18),this._upScale(this._swapFeePercentage,18)),n=this._downScaleUp(t,18);if(!this._query){for(let i=0;i<this._tokens.length;i++){const s=this._tokens[i];s.balance=W.bn(s.balance).minus(e[s.symbol]).toString()}this._bptTotalSupply=W.bn(this._bptTotalSupply).minus(n).toString()}return n.toString()}}wt.default=ft;Object.defineProperty(X,"__esModule",{value:!0});var tt=X.WeightedMath=X.WeightedPool=et=X.StableMath=X.StablePool=void 0;const ge=bt;X.StablePool=ge.default;const ke=gt;var et=X.StableMath=ke;const Se=wt;X.WeightedPool=Se.default;const we=D;tt=X.WeightedMath=we;class fe{constructor(e){F(this,"calc");F(this,"AMP_PRECISION",O(1e3));this.calc=e}exactTokensInForBPTOut(e){var t,n,i;try{const s=O(((i=(n=(t=this.calc.pool.value)==null?void 0:t.onchain)==null?void 0:n.amp)==null?void 0:i.toString())||"0"),l=this.adjustAmp(s),c=this.calc.pool.value.tokens.filter(({address:d})=>d!==this.calc.pool.value.address).map(({priceRate:d},h)=>this.scaleInput(e[h],d)),r=et._calcBptOutGivenExactTokensIn(l,this.scaledBalances,c,this.scaledPoolTotalSupply,O(this.calc.poolSwapFee.toString()));return this.scaleOutput(r.toString(),this.calc.poolDecimals,"1",z.ROUND_DOWN)}catch(s){return console.error(s),this.scaleOutput("0",this.calc.poolDecimals,"1",z.ROUND_DOWN)}}bptInForExactTokensOut(e){var l,c,r;const t=O(((r=(c=(l=this.calc.pool.value)==null?void 0:l.onchain)==null?void 0:c.amp)==null?void 0:r.toString())||"0"),n=this.adjustAmp(t),i=this.calc.pool.value.tokens.filter(d=>d.address!==this.calc.pool.value.address).map(({priceRate:d},h)=>this.scaleInput(e[h],d)),s=et._calcBptInGivenExactTokensOut(n,this.scaledBalances,i,this.scaledPoolTotalSupply,O(this.calc.poolSwapFee.toString()));return this.scaleOutput(s.toString(),this.calc.poolDecimals,"1",z.ROUND_UP)}bptInForExactTokenOut(e,t){var c,r,d;const n=O(((d=(r=(c=this.calc.pool.value)==null?void 0:c.onchain)==null?void 0:r.amp)==null?void 0:d.toString())||"0"),i=this.adjustAmp(n),s=this.calc.pool.value.tokens.map(({priceRate:h},m)=>m===t?this.scaleInput(e,h):O("0")),l=et._calcBptInGivenExactTokensOut(i,this.scaledBalances,s,this.scaledPoolTotalSupply,O(this.calc.poolSwapFee.toString()));return this.scaleOutput(l.toString(),this.calc.poolDecimals,"1",z.ROUND_UP)}exactBPTInForTokenOut(e,t){var m,b,S,g,p;const n=ot(this.calc.pool.value)[t],i=((m=Xt(this.calc.poolTokens,n))==null?void 0:m.decimals)||18,s=((b=this.calc.pool.value.tokens.find(E=>it(E.address,n)))==null?void 0:b.priceRate)||"1";if(O(e).eq(0))return this.scaleOutput("0",i,s,z.ROUND_DOWN);const l=O(((p=(g=(S=this.calc.pool.value)==null?void 0:S.onchain)==null?void 0:g.amp)==null?void 0:p.toString())||"0"),c=this.adjustAmp(l),r=K(e,this.calc.poolDecimals),d=this.scaleInput(r),h=et._calcTokenOutGivenExactBptIn(c,this.scaledBalances,t,d,this.scaledPoolTotalSupply,O(this.calc.poolSwapFee.toString()));return this.scaleOutput(h.toString(),i,s,z.ROUND_DOWN)}priceImpact(e,t){let n,i;return this.calc.action==="join"?(n=this.exactTokensInForBPTOut(e),n.isLessThan(0)?O(0):(i=this.bptForTokensZeroPriceImpact(e),O(1).minus(n.div(i)))):(t.exactOut?(n=this.bptInForExactTokensOut(e),i=this.bptForTokensZeroPriceImpact(e)):(n=U(this.calc.bptBalance,this.calc.poolDecimals).toString(),e=ot(this.calc.pool.value).map((s,l)=>{if(l!==t.tokenIndex)return"0";const c=this.exactBPTInForTokenOut(n.toString(),t.tokenIndex).toString();return K(c,this.calc.poolTokenDecimals[t.tokenIndex]).toString()}),i=this.bptForTokensZeroPriceImpact(e)),O(n).div(i).minus(1))}bptForTokensZeroPriceImpact(e){var c,r,d;const t=O(((d=(r=(c=this.calc.pool.value)==null?void 0:c.onchain)==null?void 0:r.amp)==null?void 0:d.toString())||"0"),n=ut.from(this.adjustAmp(t).toString()),i=this.calc.pool.value.tokens.filter(({address:h})=>h!==this.calc.pool.value.address).map(({priceRate:h},m)=>ut.from(this.scaleInput(e[m],h,this.calc.poolTokenDecimals[m]).toString())),s=this.scaledBalances.map((h,m)=>{const b=K(h.toFixed(),18);return U(Number(b).toFixed(this.calc.poolTokenDecimals[m]),this.calc.poolTokenDecimals[m])}),l=$t(s,this.calc.poolTokenDecimals,i,this.calc.poolTotalSupply,n);return O(l.toString())}get scaledBalances(){return this.calc.poolTokenBalances.map((e,t)=>{const n=K(e,this.calc.poolTokenDecimals[t]),i=this.scaleInput(n,this.calc.pool.value.tokens[t].priceRate);return O(i.toString())})}get scaledPoolTotalSupply(){const e=K(this.calc.poolTotalSupply,this.calc.poolDecimals),t=U(e,18);return O(t.toString())}scaleInput(e,t=null,n=18){t===null&&(t="1");const i=O(U(e,n).toString()).times(t).toFixed(0,z.ROUND_UP);return O(i.toString())}scaleOutput(e,t,n,i){n===null&&(n="1");const s=O(e).div(n).toString(),l=O(s).div(U("1",18).toString()).toFixed(t,i),c=U(l,t);return O(c.toString())}adjustAmp(e){return e.times(this.AMP_PRECISION)}}class Ie{constructor(e){F(this,"calc");F(this,"AMP_PRECISION",O(1e3));this.calc=e}priceImpact(e,t){if(!t.queryBPT)throw new Error("Need query BPT to calc StablePhantom Price Impact");console.log("Query BPT:",t.queryBPT);let n,i;return this.calc.action==="join"?(n=O(t.queryBPT),n.isLessThan(0)?O(0):(i=this.bptForTokensZeroPriceImpact(e),O(1).minus(n.div(i)))):(t.exactOut?(n=O(t.queryBPT),i=this.bptForTokensZeroPriceImpact(e)):(n=U(this.calc.bptBalance,this.calc.poolDecimals).toString(),i=this.bptForTokensZeroPriceImpact(e)),O(n).div(i).minus(1))}bptForTokensZeroPriceImpact(e){var l,c,r;const t=O(((r=(c=(l=this.calc.pool.value)==null?void 0:l.onchain)==null?void 0:c.amp)==null?void 0:r.toString())||"0"),n=ut.from(this.adjustAmp(t).toString()),i=this.calc.denormAmounts(e,this.calc.poolTokenDecimals),s=Vt(this.calc.poolTokenBalances,this.calc.poolTokenDecimals,i,this.calc.poolTotalSupply,n,this.calc.poolSwapFee,this.priceRates);return console.log("bptZeroImpact",s.toString()),O(s.toString())}get scaledBalances(){return this.calc.poolTokenBalances.map((e,t)=>{const n=K(e,this.calc.poolTokenDecimals[t]);return this.scaleInput(n,this.calc.pool.value.tokens[t].priceRate)})}scaleInput(e,t=null){t===null&&(t="1");const n=O(U(e,18).toString()).times(t).toFixed(0,z.ROUND_UP);return ut.from(n)}adjustAmp(e){return e.times(this.AMP_PRECISION)}get priceRates(){var t,n;const e=(n=(t=this.calc.pool.value)==null?void 0:t.onchain)==null?void 0:n.tokenRates;return e?e.map(i=>U(i,18)):[]}}class Pe{constructor(e){F(this,"calc");this.calc=e}exactTokensInForBPTOut(e){const t=this.calc.poolTokenBalances.map(l=>O(l.toString())),n=this.calc.poolTokenWeights.map(l=>O(l.toString())),s=this.calc.denormAmounts(e,this.calc.poolTokenDecimals).map(l=>O(l.toString()));return tt._calcBptOutGivenExactTokensIn(t,n,s,O(this.calc.poolTotalSupply.toString()),O(this.calc.poolSwapFee.toString()))}bptInForExactTokensOut(e){const t=this.calc.poolTokenBalances.map(l=>O(l.toString())),n=this.calc.poolTokenWeights.map(l=>O(l.toString())),s=this.calc.denormAmounts(e,this.calc.poolTokenDecimals).map(l=>O(l.toString()));return tt._calcBptInGivenExactTokensOut(t,n,s,O(this.calc.poolTotalSupply.toString()),O(this.calc.poolSwapFee.toString()))}bptInForExactTokenOut(e,t){const n=O(this.calc.poolTokenBalances[t].toString()),i=O(this.calc.poolTokenWeights[t].toString()),s=O(U(e,this.calc.poolTokenDecimals[t]).toString()),l=O(this.calc.poolTotalSupply.toString()),c=O(this.calc.poolSwapFee.toString());return tt._calcBptInGivenExactTokenOut(n,i,s,l,c)}exactBPTInForTokenOut(e,t){const n=O(this.calc.poolTokenBalances[t].toString()),i=O(this.calc.poolTokenWeights[t].toString());return tt._calcTokenOutGivenExactBptIn(n,i,O(e),O(this.calc.poolTotalSupply.toString()),O(this.calc.poolSwapFee.toString()))}priceImpact(e,t){let n,i;return this.calc.action==="join"?(n=this.exactTokensInForBPTOut(e),n<0?O(0):(i=this.bptForTokensZeroPriceImpact(e),O(1).minus(n.div(i)))):(t.exactOut?(n=this.bptInForExactTokensOut(e),i=this.bptForTokensZeroPriceImpact(e)):(n=t.queryBPT||U(this.calc.bptBalance,this.calc.poolDecimals).toString(),e=ot(this.calc.pool.value).map((s,l)=>{if(l!==t.tokenIndex)return"0";const c=this.exactBPTInForTokenOut(n,t.tokenIndex).toString();return K(c,this.calc.poolTokenDecimals[t.tokenIndex]).toString()}),i=this.bptForTokensZeroPriceImpact(e)),O(n).div(i).minus(1))}bptForTokensZeroPriceImpact(e){const t=this.calc.denormAmounts(e,this.calc.poolTokenDecimals);return O(zt(this.calc.poolTokenBalances,this.calc.poolTokenDecimals,this.calc.poolTokenWeights,t,this.calc.poolTotalSupply).toString())}}class Ze{constructor(e,t,n,i,s=vt(!1),l=Pe,c=fe,r=Ie,d=yt){F(this,"types",["send","receive"]);F(this,"weighted");F(this,"stable");F(this,"stablePhantom");this.pool=e,this.allTokens=t,this.balances=n,this.action=i,this.useNativeAsset=s,this.config=d,this.weighted=new l(this),this.stable=new c(this),this.stablePhantom=new r(this)}priceImpact(e,t={exactOut:!1,tokenIndex:0}){return this.isStableLikePool?Kt(this.pool.value)?this.stablePhantom.priceImpact(e,t):this.stable.priceImpact(e,t):this.weighted.priceImpact(e,t)}exactTokensInForBPTOut(e){return this.isStableLikePool?this.stable.exactTokensInForBPTOut(e):this.weighted.exactTokensInForBPTOut(e)}exactBPTInForTokenOut(e,t){return this.isStableLikePool?this.stable.exactBPTInForTokenOut(e,t):this.weighted.exactBPTInForTokenOut(e,t)}bptInForExactTokenOut(e,t){return this.isStableLikePool?this.stable.bptInForExactTokenOut(e,t):this.weighted.bptInForExactTokenOut(e,t)}propMax(){let e={send:[],receive:[],fixedToken:0};const t=this.action==="join"?"send":"receive";return this.tokenAddresses.forEach((n,i)=>{let s=!0,l;n===this.config.network.nativeAsset.address?l=O(this.balances.value[lt(n)]).minus(this.config.network.nativeAsset.minTransactionBuffer).toString():l=this.balances.value[lt(n)]||"0";const c=this.propAmountsGiven(l,i,t);if(c.send.forEach((r,d)=>{O(r).gt(this.balances.value[this.tokenOf(t,d)])&&(s=!1)}),s){const r=parseFloat(e.send[i]||"0");parseFloat(c.send[i])>r&&(e=c,e.fixedToken=i)}}),e}propAmountsGiven(e,t,n,i){if(e.trim()==="")return{send:[],receive:[],fixedToken:0};const s=["send","receive"],l=this.tokenOf(n,t),c=this.allTokens.value[l],r=U(e,c==null?void 0:c.decimals),d=this.ratioOf(n,t),h={send:this.sendTokens.map(()=>""),receive:this.receiveTokens.map(()=>""),fixedToken:t};return h[n][t]=e,[this.sendRatios,this.receiveRatios].forEach((m,b)=>{m.forEach((S,g)=>{if(g!==t||n!==s[b]){const p=this.tokenOf(s[b],g),E=this.allTokens.value[p];let I;i?I=r.sub(i.buffer).mul(i.bps).div(1e4).mul(S).div(i.value):I=r.mul(S).div(d),h[s[b]][g]=K(I,E==null?void 0:E.decimals)}})}),h}denormAmounts(e,t){return e.map((n,i)=>U(n,t[i]))}tokenOf(e,t){return lt(this[`${e}Tokens`][t])}ratioOf(e,t){return this[`${e}Ratios`][t]}get tokenAddresses(){const e=ot(this.pool.value);return this.useNativeAsset.value?e.map(t=>it(t,this.config.network.addresses.weth)?this.config.network.nativeAsset.address:t):e}get poolTokens(){var e,t;return(t=(e=this.pool.value)==null?void 0:e.onchain)!=null&&t.tokens?this.pool.value.onchain.tokens:{}}get poolTokenBalances(){var t,n;return(n=(t=this.pool.value)==null?void 0:t.onchain)!=null&&n.tokens?Object.values(this.poolTokens).map(i=>i.balance).map((i,s)=>U(i,this.poolTokenDecimals[s])):[]}get poolTokenDecimals(){return Object.values(this.poolTokens).map(e=>e.decimals)}get poolTokenWeights(){return Object.values(this.poolTokens).map(t=>t.weight).map(t=>U(t.toString(),18))}get poolTotalSupply(){var e,t;return U(((t=(e=this.pool.value)==null?void 0:e.onchain)==null?void 0:t.totalSupply)||"0",this.poolDecimals)}get poolSwapFee(){var e,t;return U(((t=(e=this.pool.value)==null?void 0:e.onchain)==null?void 0:t.swapFee)||"0",18)}get poolDecimals(){var e,t;return((t=(e=this.pool.value)==null?void 0:e.onchain)==null?void 0:t.decimals)||18}get bptBalance(){return this.balances.value[lt(this.pool.value.address)]}get isStablePool(){return Ht(this.pool.value.poolType)}get isStableLikePool(){return Tt(this.pool.value.poolType)}get isComposableStableLikePool(){return Jt(this.pool.value.poolType)}get sendTokens(){return this.action==="join"?this.tokenAddresses:[this.pool.value.address]}get receiveTokens(){return this.action==="join"?[this.pool.value.address]:this.tokenAddresses}get sendRatios(){return this.action==="join"?this.poolTokenBalances:[this.poolTotalSupply]}get receiveRatios(){return this.action==="join"?[this.poolTotalSupply]:this.poolTokenBalances}}function Ae(o){return o.kind=="Init"?Q.joinInit(o.amountsIn):o.kind=="ExactTokensInForBPTOut"?Q.joinExactTokensInForBPTOut(o.amountsIn,o.minimumBPT):Q.joinTokenInForExactBPTOut(o.bptAmountOut,o.enterTokenIndex)}function Be(o){return o.kind=="ExactBPTInForOneTokenOut"?Q.exitExactBPTInForOneTokenOut(o.bptAmountIn,o.exitTokenIndex):o.kind=="ExactBPTInForTokensOut"?Q.exitExactBPTInForTokensOut(o.bptAmountIn):Q.exitBPTInForExactTokensOut(o.amountsOut,o.maxBPTAmountIn)}function ye(o){return o.kind=="Init"?H.joinInit(o.amountsIn):o.kind=="ExactTokensInForBPTOut"?H.joinExactTokensInForBPTOut(o.amountsIn,o.minimumBPT):o.kind=="AllTokensInForExactBPTOut"?H.joinAllTokensInForExactBPTOut(o.bptAmountOut):H.joinTokenInForExactBPTOut(o.bptAmountOut,o.enterTokenIndex)}function Ne(o){return o.kind=="ExactBPTInForOneTokenOut"?H.exitExactBPTInForOneTokenOut(o.bptAmountIn,o.exitTokenIndex):o.kind=="ExactBPTInForTokensOut"?H.exitExactBPTInForTokensOut(o.bptAmountIn):H.exitBPTInForExactTokensOut(o.amountsOut,o.maxBPTAmountIn)}function Fe(o){return o.kind=="Init"?nt.joinInit(o.amountsIn):o.kind=="ExactTokensInForBPTOut"?nt.joinExactTokensInForBPTOut(o.amountsIn,o.minimumBPT):nt.joinTokenInForExactBPTOut(o.bptAmountOut,o.enterTokenIndex)}function Re(o){return o.kind=="ExactBPTInForOneTokenOut"?nt.exitExactBPTInForOneTokenOut(o.bptAmountIn,o.exitTokenIndex):nt.exitBPTInForExactTokensOut(o.amountsOut,o.maxBPTAmountIn)}class De{constructor(e){F(this,"pool");F(this,"config");F(this,"isStableLike");F(this,"dataEncodeFn");F(this,"toInternalBalance",!1);this.pool=e.pool,this.config=e.config,this.isStableLike=Tt(e.pool.value.poolType),this.dataEncodeFn=this.isStableLike?J(e.pool.value.poolType)?Re:Be:Ne}serialize(e,t,n,i,s,l){var S,g,p;const c=this.parseAmounts(t),r=U(i,((g=(S=this.pool.value)==null?void 0:S.onchain)==null?void 0:g.decimals)||18),d=this.parseTokensOut(n),h=this.txData(c,r,s,l),m=c.map(E=>E.gt(0)?E.sub(1):E),b=pt(this.pool.value);return J(this.pool.value.poolType)&&b!==void 0&&m.splice(b,0,U("0",((p=this.pool.value.onchain)==null?void 0:p.decimals)||18)),[this.pool.value.id,e,e,{assets:d,minAmountsOut:m,userData:h,toInternalBalance:this.toInternalBalance}]}parseAmounts(e){const t=ot(this.pool.value);try{return e.map((n,i)=>{var l,c,r,d;const s=t[i];return U(n,(d=(r=(c=(l=this.pool.value)==null?void 0:l.onchain)==null?void 0:c.tokens)==null?void 0:r[s])==null?void 0:d.decimals)})}catch(n){throw console.error("Failed to parse amountsOut",n),new Error("Failed to parse amounts out.")}}parseTokensOut(e){const t=this.config.network.nativeAsset,n=pt(this.pool.value),i=e.map(s=>it(s,t.address)?Nt:s);return J(this.pool.value.poolType)&&n!==void 0&&!Ft(i,this.pool.value.address)&&i.splice(n,0,this.pool.value.address),i}txData(e,t,n,i){return n!==null?this.dataEncodeFn({kind:"ExactBPTInForOneTokenOut",bptAmountIn:t,exitTokenIndex:n}):i?this.dataEncodeFn({amountsOut:e,maxBPTAmountIn:t}):J(this.pool.value.poolType)?this.dataEncodeFn({amountsOut:e,maxBPTAmountIn:t}):this.dataEncodeFn({kind:"ExactBPTInForTokensOut",bptAmountIn:t})}}class Ue{constructor(e){F(this,"pool");F(this,"config");F(this,"isStableLikePool");F(this,"isManagedPool");F(this,"isSwapEnabled");F(this,"dataEncodeFn");F(this,"fromInternalBalance",!1);var t,n;this.pool=e.pool,this.config=e.config,this.isStableLikePool=Tt(this.pool.value.poolType),this.isManagedPool=Qt(this.pool.value.poolType),this.isSwapEnabled=this.isManagedPool&&!!((n=(t=this.pool.value)==null?void 0:t.onchain)!=null&&n.swapEnabled),this.dataEncodeFn=this.isStableLikePool?J(e.pool.value.poolType)?Fe:Ae:ye}serialize(e,t,n,i){var m,b,S;const s=this.parseAmounts(t,n),l=U(i,((b=(m=this.pool.value)==null?void 0:m.onchain)==null?void 0:b.decimals)||18),c=this.txData(s,l),r=this.parseTokensIn(n),d=pt(this.pool.value),h=[...s];return J(this.pool.value.poolType)&&d!==void 0&&h.splice(d,0,U("0",((S=this.pool.value.onchain)==null?void 0:S.decimals)||18)),[this.pool.value.id,e,e,{assets:r,maxAmountsIn:h,userData:c,fromInternalBalance:this.fromInternalBalance}]}value(e,t){let n="0";const i=this.config.network.nativeAsset;return e.forEach((s,l)=>{t[l]===i.address&&(n=s)}),U(n,i.decimals)}parseAmounts(e,t){const n=this.config.network.nativeAsset;return e.map((s,l)=>{var d,h,m,b;const c=t[l],r=it(n.address,c)?n.decimals:((b=(m=(h=(d=this.pool.value)==null?void 0:d.onchain)==null?void 0:h.tokens)==null?void 0:m[c])==null?void 0:b.decimals)||18;return U(s,r)})}parseTokensIn(e){const t=this.config.network.nativeAsset,n=pt(this.pool.value),i=e.map(s=>it(s,t.address)?Nt:s);return J(this.pool.value.poolType)&&n!==void 0&&!Ft(i,this.pool.value.address)&&i.splice(n,0,this.pool.value.address),i}txData(e,t){var n,i;return(((i=(n=this.pool.value)==null?void 0:n.onchain)==null?void 0:i.totalSupply)||"0")==="0"?this.dataEncodeFn({kind:"Init",amountsIn:e}):this.isManagedPool&&!this.isSwapEnabled?this.dataEncodeFn({kind:"AllTokensInForExactBPTOut",bptAmountOut:t}):this.dataEncodeFn({kind:"ExactTokensInForBPTOut",amountsIn:e,minimumBPT:t})}}class Ce{constructor(e,t=yt){F(this,"pool");F(this,"vaultAddress");F(this,"helpersAddress");this.config=t,this.pool=e,this.vaultAddress=this.config.network.addresses.vault,this.helpersAddress=this.config.network.addresses.balancerHelpers}async queryJoin(e,t,n,i="0"){const s=await e.getAddress(),l=this.joinParams.serialize(s,t,n,i);return await new ct(e).contract.callStatic({contractAddress:this.helpersAddress,abi:rt.BalancerHelpers__factory.abi,action:"queryJoin",params:l})}async join(e,t,n,i="0"){const s=await e.getAddress(),l=this.joinParams.serialize(s,t,n,i),c=this.joinParams.value(t,n);return await new ct(e).contract.sendTransaction({contractAddress:this.vaultAddress,abi:rt.Vault__factory.abi,action:"joinPool",params:l,options:{value:c}})}async queryExit(e,t,n,i,s,l){const c=await e.getAddress(),r=this.exitParams.serialize(c,t,n,i,s,l);return await new ct(e).contract.callStatic({contractAddress:this.helpersAddress,abi:rt.BalancerHelpers__factory.abi,action:"queryExit",params:r})}async exit(e,t,n,i,s,l){const c=await e.getAddress(),r=this.exitParams.serialize(c,t,n,i,s,l);return await new ct(e).contract.sendTransaction({contractAddress:this.vaultAddress,abi:rt.Vault__factory.abi,action:"exitPool",params:r})}get joinParams(){return new Ue(this)}get exitParams(){return new De(this)}}export{Ze as C,Ce as E,We as u};
//# sourceMappingURL=exchange.service-4f09193f.js.map
